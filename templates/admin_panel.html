<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wedding Admin Panel</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link href="/static/styles.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .hero-section {
            border-radius: 15px;
            margin-bottom: 2rem;
        }
        .step-card {
            transition: transform 0.2s;
        }
        .step-card:hover {
            transform: translateY(-2px);
        }
        .success-alert {
            display: none;
        }
        .error-alert {
            display: none;
        }
        .loading-spinner {
            display: none;
        }
        .event-code-display {
            display: none;
            background: var(--bs-success-bg-subtle);
            border: 2px solid var(--bs-success);
            border-radius: 10px;
            padding: 1.5rem;
            margin-top: 1rem;
        }
        .code-value {
            font-family: 'Courier New', monospace;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--bs-success);
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <!-- Hero Section -->
        <div class="hero-section p-4 text-center">
            <h1 class="display-4 mb-3">
                <i class="fas fa-cogs text-primary"></i>
                Wedding Admin Panel
            </h1>
            <p class="lead mb-0">Create events and upload seating arrangements</p>
        </div>

        <!-- Alert Messages -->
        <div id="successAlert" class="alert alert-success success-alert" role="alert">
            <i class="fas fa-check-circle"></i>
            <span id="successMessage"></span>
        </div>

        <div id="errorAlert" class="alert alert-danger error-alert" role="alert">
            <i class="fas fa-exclamation-triangle"></i>
            <span id="errorMessage"></span>
        </div>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="text-center loading-spinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Processing...</span>
            </div>
            <p class="mt-2">Processing your request...</p>
        </div>

        <!-- Create Event & Upload Excel Form -->
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <div class="card step-card">
                    <div class="card-header">
                        <h4 class="card-title mb-0">
                            <i class="fas fa-plus-circle text-success"></i>
                            Create Event & Upload Seating
                        </h4>
                    </div>
                    <div class="card-body">
                        <form id="createEventForm" enctype="multipart/form-data">
                            <!-- Event Details -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="eventName" class="form-label">Event Name *</label>
                                    <input type="text" class="form-control" id="eventName" placeholder="e.g., Emma & Michael's Wedding" required>
                                    <div class="form-text">The name of your wedding event</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="eventDate" class="form-label">Event Date *</label>
                                    <input type="datetime-local" class="form-control" id="eventDate" required>
                                    <div class="form-text">Date and time of the wedding</div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="organizerEmail" class="form-label">Organizer Email *</label>
                                <input type="email" class="form-control" id="organizerEmail" placeholder="organizer@email.com" required>
                                <div class="form-text">Email address for event management</div>
                            </div>

                            <!-- Excel Upload -->
                            <div class="mb-3">
                                <label for="excelFile" class="form-label">Excel Seating File *</label>
                                <input type="file" class="form-control" id="excelFile" accept=".xlsx,.xls" required>
                                <div class="form-text">
                                    Upload your Excel file with columns: Name, Table, Seat No., Dietary Preference
                                    <br><small><a href="/template/wedding_seating_template.xlsx" target="_blank">
                                        <i class="fas fa-download"></i> Download Template
                                    </a></small>
                                </div>
                            </div>

                            <!-- Submit Button -->
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-upload"></i>
                                    Create Event & Upload Seating
                                </button>
                            </div>
                        </form>

                        <!-- Event Code Display -->
                        <div id="eventCodeDisplay" class="event-code-display">
                            <div class="text-center">
                                <h5 class="mb-3">
                                    <i class="fas fa-check-circle text-success"></i>
                                    Event Created Successfully!
                                </h5>
                                <p class="mb-2">Your Event Code:</p>
                                <div class="code-value" id="eventCodeValue"></div>
                                <p class="mt-3 mb-0">
                                    <small>Share this code with your guests to access the guest portal at 
                                    <strong id="guestPortalUrl"></strong></small>
                                </p>
                                <div class="mt-3">
                                    <button type="button" class="btn btn-outline-success" onclick="copyEventCode()">
                                        <i class="fas fa-copy"></i> Copy Event Code
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" onclick="openGuestPortal()">
                                        <i class="fas fa-external-link-alt"></i> Open Guest Portal
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Instructions -->
        <div class="row mt-4">
            <div class="col-lg-8 mx-auto">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-info-circle text-info"></i>
                            Instructions
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-file-excel text-success"></i> Excel File Format</h6>
                                <ul class="list-unstyled ms-3">
                                    <li><i class="fas fa-check text-success"></i> Name column (guest names)</li>
                                    <li><i class="fas fa-check text-success"></i> Table column (table names/numbers)</li>
                                    <li><i class="fas fa-check text-success"></i> Seat No. column (seat numbers)</li>
                                    <li><i class="fas fa-check text-success"></i> Dietary Preference column</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-users text-primary"></i> Table Limits</h6>
                                <ul class="list-unstyled ms-3">
                                    <li><i class="fas fa-info text-info"></i> Maximum 12 guests per table</li>
                                    <li><i class="fas fa-info text-info"></i> Unique seat numbers per table</li>
                                    <li><i class="fas fa-info text-info"></i> Dietary options: None, Vegetarian, Halal, Allergies</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let createdEventCode = '';

        document.getElementById('createEventForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const eventName = document.getElementById('eventName').value.trim();
            const eventDate = document.getElementById('eventDate').value;
            const organizerEmail = document.getElementById('organizerEmail').value.trim();
            const excelFile = document.getElementById('excelFile').files[0];
            
            if (!eventName || !eventDate || !organizerEmail || !excelFile) {
                showError('Please fill in all required fields and select an Excel file');
                return;
            }
            
            showLoading(true);
            hideAlerts();
            
            try {
                // Create form data
                const formData = new FormData();
                formData.append('name', eventName);
                formData.append('date', eventDate);
                formData.append('organizer_email', organizerEmail);
                formData.append('file', excelFile);
                
                // Submit to combined endpoint
                const response = await fetch('/admin/create-event-with-excel', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    createdEventCode = result.data.public_code;
                    showEventSuccess(result.data);
                    resetForm();
                } else {
                    showError(result.message || 'Failed to create event and upload Excel file');
                    if (result.details) {
                        console.error('Validation errors:', result.details);
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                showError('Failed to connect to the server. Please try again.');
            } finally {
                showLoading(false);
            }
        });
        
        function showEventSuccess(eventData) {
            const eventCodeDisplay = document.getElementById('eventCodeDisplay');
            const eventCodeValue = document.getElementById('eventCodeValue');
            const guestPortalUrl = document.getElementById('guestPortalUrl');
            
            eventCodeValue.textContent = eventData.public_code;
            guestPortalUrl.textContent = `${window.location.origin}/?event=${eventData.public_code}`;
            
            eventCodeDisplay.style.display = 'block';
            
            showSuccess(`Event "${eventData.name}" created successfully with ${eventData.guest_count} guests`);
        }
        
        function copyEventCode() {
            if (createdEventCode) {
                navigator.clipboard.writeText(createdEventCode).then(() => {
                    showSuccess('Event code copied to clipboard!');
                });
            }
        }
        
        function openGuestPortal() {
            if (createdEventCode) {
                window.open(`/?event=${createdEventCode}`, '_blank');
            }
        }
        
        function resetForm() {
            document.getElementById('createEventForm').reset();
        }
        
        function showSuccess(message) {
            document.getElementById('successMessage').textContent = message;
            document.getElementById('successAlert').style.display = 'block';
            document.getElementById('errorAlert').style.display = 'none';
        }
        
        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorAlert').style.display = 'block';
            document.getElementById('successAlert').style.display = 'none';
        }
        
        function hideAlerts() {
            document.getElementById('successAlert').style.display = 'none';
            document.getElementById('errorAlert').style.display = 'none';
        }
        
        function showLoading(show) {
            document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
            const submitBtn = document.querySelector('button[type="submit"]');
            submitBtn.disabled = show;
            
            if (show) {
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            } else {
                submitBtn.innerHTML = '<i class="fas fa-upload"></i> Create Event & Upload Seating';
            }
        }
    </script>
</body>
</html>